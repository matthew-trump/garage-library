<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Garage Library</title>
  <link rel="icon" type="image/png" href="/static/favicon.png">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
      color: #333;
    }

    #navbar {
      background: #1a252f;
      color: #ecf0f1;
      padding: 0.6rem 1.25rem;
      flex-shrink: 0;
      display: flex;
      align-items: center;
    }

    #navbar a {
      color: #ecf0f1;
      text-decoration: none;
      font-size: 1.1rem;
      font-weight: 700;
    }

    #navbar-home {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    #navbar-logo {
      height: 28px;
      width: 28px;
      object-fit: contain;
    }

    #navbar a:hover { color: #aed6f1; }

    #navbar .nav-links {
      margin-left: auto;
      display: flex;
      gap: 1rem;
    }

    #navbar .nav-links a {
      font-size: 0.9rem;
      font-weight: 400;
    }

    #content {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    #sidebar {
      width: 200px;
      background: #2c3e50;
      color: #ecf0f1;
      padding: 1rem 0;
      overflow-y: auto;
      flex-shrink: 0;
    }

    #sidebar h2 {
      padding: 0 1rem 0.75rem;
      font-size: 1.1rem;
      border-bottom: 1px solid #3d566e;
      margin-bottom: 0.5rem;
    }

    #stack-list {
      list-style: none;
    }

    #stack-list li {
      padding: 0.5rem 1rem;
      cursor: pointer;
      transition: background 0.15s;
    }

    #stack-list li:hover {
      background: #3d566e;
    }

    #stack-list li.active {
      background: #2980b9;
      font-weight: 600;
    }

    #main {
      flex: 1;
      padding: 2rem;
      overflow-y: auto;
      background: #fafafa;
    }

    #main h1 {
      margin-bottom: 1rem;
      font-size: 1.5rem;
    }

    #welcome p {
      color: #666;
      line-height: 1.6;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    th, td {
      text-align: left;
      padding: 0.6rem 1rem;
      border-bottom: 1px solid #eee;
    }

    th {
      background: #ecf0f1;
      font-weight: 600;
      font-size: 0.85rem;
      text-transform: uppercase;
      color: #555;
    }

    td { font-size: 0.95rem; }

    tr:hover td { background: #f5f8fa; }

    td a { color: #2980b9; text-decoration: none; }
    td a:hover { text-decoration: underline; }

    #book-view { display: none; }

    .book-detail {
      background: #fff;
      padding: 1.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      max-width: 600px;
    }

    .book-detail dl {
      display: grid;
      grid-template-columns: 120px 1fr;
      row-gap: 0.6rem;
    }

    .book-detail dt {
      font-weight: 600;
      color: #555;
      font-size: 0.85rem;
      text-transform: uppercase;
    }

    .book-detail dd { margin: 0; }
    .book-detail dd a { color: #2980b9; text-decoration: none; }
    .book-detail dd a:hover { text-decoration: underline; }

    .stack-toolbar {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .stack-toolbar h1 { margin-bottom: 0; }

    .stack-toolbar button {
      padding: 0.35rem 0.75rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #fff;
      cursor: pointer;
      font-size: 0.85rem;
    }

    .stack-toolbar button:hover { background: #ecf0f1; }

    .stack-toolbar .btn-save {
      background: #2980b9;
      color: #fff;
      border-color: #2980b9;
    }

    .stack-toolbar .btn-save:hover { background: #2472a4; }

    .stack-toolbar .btn-save:disabled {
      background: #a0c4e0;
      border-color: #a0c4e0;
      cursor: default;
    }

    .stack-toolbar .btn-cancel {
      background: #e74c3c;
      color: #fff;
      border-color: #e74c3c;
    }

    .stack-toolbar .btn-cancel:hover:not(:disabled) { background: #c0392b; }

    .stack-toolbar .btn-cancel:disabled {
      background: #f1a9a0;
      border-color: #f1a9a0;
      cursor: default;
    }

    .edit-mode tr { cursor: grab; }
    .edit-mode tr.dragging { opacity: 0.4; }
    .edit-mode tr.drag-over td { border-top: 2px solid #2980b9; }

    .edit-mode td a { pointer-events: none; color: inherit; }

    .error-msg {
      background: #fdecea;
      color: #c0392b;
      border: 1px solid #e6b0aa;
      padding: 0.6rem 1rem;
      border-radius: 4px;
      margin-bottom: 1rem;
      display: none;
    }

    .success-msg {
      background: #eafaf1;
      color: #1e8449;
      border: 1px solid #a9dfbf;
      padding: 0.6rem 1rem;
      border-radius: 4px;
      margin-bottom: 1rem;
      display: none;
    }

    .book-toolbar {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .book-toolbar h1 { margin-bottom: 0; }

    .book-toolbar button {
      padding: 0.35rem 0.75rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #fff;
      cursor: pointer;
      font-size: 0.85rem;
    }

    .book-toolbar button:hover { background: #ecf0f1; }

    .book-toolbar .btn-save {
      background: #2980b9;
      color: #fff;
      border-color: #2980b9;
    }

    .book-toolbar .btn-save:hover { background: #2472a4; }

    .book-toolbar .btn-save:disabled {
      background: #a0c4e0;
      border-color: #a0c4e0;
      cursor: default;
    }

    .book-toolbar .btn-cancel {
      background: #e74c3c;
      color: #fff;
      border-color: #e74c3c;
    }

    .book-toolbar .btn-cancel:hover:not(:disabled) { background: #c0392b; }

    .book-toolbar .btn-cancel:disabled {
      background: #f1a9a0;
      border-color: #f1a9a0;
      cursor: default;
    }

    .book-detail input[type="text"] {
      width: 100%;
      padding: 0.35rem 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.95rem;
      font-family: inherit;
    }

    .book-detail select {
      padding: 0.35rem 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.95rem;
      font-family: inherit;
    }

    .info-msg {
      background: #ebf5fb;
      color: #2471a3;
      border: 1px solid #aed6f1;
      padding: 0.6rem 1rem;
      border-radius: 4px;
      margin-bottom: 1rem;
      display: none;
    }

    #new-stack-view { display: none; }

    .form-group {
      margin-bottom: 1rem;
      max-width: 400px;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      font-size: 0.85rem;
      text-transform: uppercase;
      color: #555;
      margin-bottom: 0.3rem;
    }

    .form-group input[type="text"] {
      width: 100%;
      padding: 0.45rem 0.6rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.95rem;
      font-family: inherit;
    }

    .form-actions {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .form-actions button {
      padding: 0.4rem 0.85rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #fff;
      cursor: pointer;
      font-size: 0.85rem;
    }

    .form-actions .btn-primary {
      background: #2980b9;
      color: #fff;
      border-color: #2980b9;
    }

    .form-actions .btn-primary:hover:not(:disabled) { background: #2472a4; }

    .form-actions .btn-primary:disabled {
      background: #a0c4e0;
      border-color: #a0c4e0;
      cursor: default;
    }

    .form-actions button:not(.btn-primary):hover { background: #ecf0f1; }

    #sidebar-add-stack {
      padding: 0.5rem 1rem;
      margin-top: 0.25rem;
      cursor: pointer;
      transition: background 0.15s;
      border-top: 1px solid #3d566e;
      font-size: 0.85rem;
      color: #aed6f1;
    }

    #sidebar-add-stack:hover { background: #3d566e; }

    #search-view { display: none; }

    .search-bar {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
      max-width: 600px;
    }

    .search-bar input[type="text"] {
      flex: 1;
      padding: 0.45rem 0.6rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.95rem;
      font-family: inherit;
    }

    .search-bar button {
      padding: 0.45rem 1rem;
      background: #2980b9;
      color: #fff;
      border: 1px solid #2980b9;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
    }

    .search-bar button:hover { background: #2472a4; }

    .search-bar button:disabled {
      background: #a0c4e0;
      border-color: #a0c4e0;
      cursor: default;
    }

    .search-options {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }

    .search-options label {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <header id="navbar">
    <a href="/" id="navbar-home"><img id="navbar-logo" src="/static/logo.png" alt=""> Garage Library</a>
    <div class="nav-links">
      <a href="/search" id="navbar-search">Search</a>
    </div>
  </header>
  <div id="content">
  <nav id="sidebar">
    <h2>Stacks</h2>
    <ul id="stack-list"></ul>
    <div id="sidebar-add-stack">+ New Stack</div>
  </nav>

  <main id="main">
    <div id="welcome">
      <h1>Garage Library</h1>
      <p>Select a stack from the sidebar to view its books.</p>
    </div>
    <div id="search-view">
      <h1>Search Books</h1>
      <div class="search-bar">
        <input type="text" id="search-input" placeholder="Search...">
        <button id="btn-search">Search</button>
      </div>
      <div class="search-options">
        <label><input type="checkbox" id="search-title" checked> Title</label>
        <label><input type="checkbox" id="search-author" checked> Author</label>
        <label><input type="checkbox" id="search-publisher"> Publisher</label>
      </div>
      <div id="search-error" class="error-msg"></div>
      <p id="search-count" style="color:#666; margin-bottom:0.5rem; display:none;"></p>
      <table id="search-results-table" style="display:none;">
        <thead>
          <tr>
            <th>Title</th>
            <th>Author</th>
            <th>Publisher</th>
            <th>Stack</th>
          </tr>
        </thead>
        <tbody id="search-results-tbody"></tbody>
      </table>
    </div>
    <div id="book-view">
      <div class="book-toolbar">
        <h1 id="book-title"></h1>
        <button id="btn-book-edit">Edit</button>
        <button id="btn-book-save" class="btn-save" style="display:none">Save</button>
        <button id="btn-book-cancel" class="btn-cancel" style="display:none">Cancel</button>
      </div>
      <div id="book-error-msg" class="error-msg"></div>
      <div id="book-success-msg" class="success-msg"></div>
      <div id="book-info-msg" class="info-msg"></div>
      <div class="book-detail">
        <dl id="book-detail-dl"></dl>
      </div>
    </div>
    <div id="new-stack-view">
      <h1>New Stack</h1>
      <div id="new-stack-error" class="error-msg"></div>
      <div class="form-group">
        <label for="new-stack-name">Stack Name</label>
        <input type="text" id="new-stack-name" placeholder="e.g. AB">
      </div>
      <div class="form-actions">
        <button id="btn-create-stack" class="btn-primary" disabled>Create Stack</button>
        <button id="btn-cancel-create">Cancel</button>
      </div>
      <div id="new-stack-followup" class="form-actions" style="display:none; margin-top:1rem;">
        <button id="btn-add-another">Add Another</button>
        <button id="btn-goto-stack">Go to Stack</button>
      </div>
    </div>
    <div id="stack-view" style="display:none">
      <div class="stack-toolbar">
        <h1 id="stack-name"></h1>
        <button id="btn-edit-stack">Edit Stack</button>
        <button id="btn-edit">Edit Order</button>
        <button id="btn-save" class="btn-save" style="display:none" disabled>Save</button>
        <button id="btn-cancel" class="btn-cancel" style="display:none">Cancel</button>
      </div>
      <p id="stack-location" style="color:#666; margin-bottom:1rem;"></p>
      <div id="stack-edit-form" style="display:none; background:#fff; padding:1rem; box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-bottom:1rem; max-width:400px;">
        <div id="stack-edit-error" class="error-msg"></div>
        <div class="form-group">
          <label for="stack-edit-name">Name</label>
          <input type="text" id="stack-edit-name">
        </div>
        <div class="form-group">
          <label for="stack-edit-location">Location</label>
          <input type="text" id="stack-edit-location">
        </div>
        <div class="form-actions">
          <button id="btn-save-stack-edit" class="btn-primary" disabled>Save</button>
          <button id="btn-cancel-stack-edit">Cancel</button>
        </div>
      </div>
      <div id="stack-edit-success" class="success-msg" style="max-width:400px;"></div>
      <div id="error-msg" class="error-msg"></div>
      <div id="add-book-area">
        <button id="btn-add-book" style="margin-bottom:1rem;">+ Add Book</button>
        <div id="add-book-success" class="success-msg" style="max-width:500px;"></div>
        <div id="add-book-form" style="display:none; background:#fff; padding:1rem; box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-bottom:1rem; max-width:500px;">
          <div id="add-book-error" class="error-msg"></div>
          <div class="form-group">
            <label for="add-book-title">Title</label>
            <input type="text" id="add-book-title">
          </div>
          <div class="form-group">
            <label for="add-book-author">Author</label>
            <input type="text" id="add-book-author">
          </div>
          <div class="form-group">
            <label for="add-book-publisher">Publisher</label>
            <input type="text" id="add-book-publisher">
          </div>
          <div class="form-group">
            <label for="add-book-position">Add at</label>
            <select id="add-book-position">
              <option value="end" selected>End of stack</option>
              <option value="beginning">Beginning of stack</option>
            </select>
          </div>
          <div class="form-actions">
            <button id="btn-save-new-book" class="btn-primary" disabled>Save</button>
            <button id="btn-cancel-new-book">Cancel</button>
          </div>
        </div>
      </div>
      <table id="stack-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Title</th>
            <th>Author</th>
            <th>Publisher</th>
          </tr>
        </thead>
        <tbody id="book-tbody"></tbody>
      </table>
    </div>
  </main>
  </div>

  <script>
    const stackList = document.getElementById("stack-list");
    const welcome = document.getElementById("welcome");
    const stackView = document.getElementById("stack-view");
    const stackName = document.getElementById("stack-name");
    const bookTbody = document.getElementById("book-tbody");
    const bookView = document.getElementById("book-view");
    const bookTitle = document.getElementById("book-title");
    const bookDetailDl = document.getElementById("book-detail-dl");
    const stackTable = document.getElementById("stack-table");
    const btnEdit = document.getElementById("btn-edit");
    const btnSave = document.getElementById("btn-save");
    const btnCancel = document.getElementById("btn-cancel");
    const errorMsg = document.getElementById("error-msg");
    const btnBookEdit = document.getElementById("btn-book-edit");
    const btnBookSave = document.getElementById("btn-book-save");
    const btnBookCancel = document.getElementById("btn-book-cancel");
    const bookErrorMsg = document.getElementById("book-error-msg");
    const bookSuccessMsg = document.getElementById("book-success-msg");
    const bookInfoMsg = document.getElementById("book-info-msg");

    let stacksCache = null;
    let currentStackId = null;
    let currentBooks = [];
    let editMode = false;
    let orderChanged = false;
    let dragRow = null;
    let currentBook = null;
    let bookEditMode = false;
    let successTimer = null;

    const newStackView = document.getElementById("new-stack-view");
    const newStackName = document.getElementById("new-stack-name");
    const newStackError = document.getElementById("new-stack-error");
    const btnCreateStack = document.getElementById("btn-create-stack");
    const newStackFollowup = document.getElementById("new-stack-followup");
    const btnAddAnother = document.getElementById("btn-add-another");
    const btnGotoStack = document.getElementById("btn-goto-stack");
    let createdStackId = null;

    const searchView = document.getElementById("search-view");

    function showView(name) {
      welcome.style.display = name === "welcome" ? "block" : "none";
      stackView.style.display = name === "stack" ? "block" : "none";
      bookView.style.display = name === "book" ? "block" : "none";
      newStackView.style.display = name === "new-stack" ? "block" : "none";
      searchView.style.display = name === "search" ? "block" : "none";
    }

    function navigate(url) {
      if (editMode) exitEditMode();
      history.pushState(null, "", url);
      route();
    }

    async function loadStacks() {
      if (stacksCache) return stacksCache;
      const res = await fetch("/api/stacks");
      stacksCache = await res.json();
      stacksCache.sort((a, b) => a.name.localeCompare(b.name));
      stackList.innerHTML = "";
      stacksCache.forEach(s => {
        const li = document.createElement("li");
        li.textContent = "Stack " + s.name;
        li.dataset.id = s.id;
        li.addEventListener("click", (e) => {
          e.preventDefault();
          navigate("/stacks/" + s.id);
        });
        stackList.appendChild(li);
      });
      return stacksCache;
    }

    function highlightSidebar(stackId) {
      document.querySelectorAll("#stack-list li").forEach(el => {
        el.classList.toggle("active", el.dataset.id === String(stackId));
      });
    }

    function renderBooks(books) {
      bookTbody.innerHTML = "";
      books.forEach((book, idx) => {
        const tr = document.createElement("tr");
        tr.dataset.bookId = book.id;
        tr.draggable = false;

        const posTd = document.createElement("td");
        posTd.textContent = idx;
        const titleTd = document.createElement("td");
        const titleLink = document.createElement("a");
        titleLink.href = "/book/" + book.id;
        titleLink.textContent = book.title;
        titleLink.addEventListener("click", (e) => {
          e.preventDefault();
          navigate("/book/" + book.id);
        });
        titleTd.appendChild(titleLink);
        const authorTd = document.createElement("td");
        authorTd.textContent = book.author || "\u2014";
        const pubTd = document.createElement("td");
        pubTd.textContent = book.publisher || "\u2014";

        tr.appendChild(posTd);
        tr.appendChild(titleTd);
        tr.appendChild(authorTd);
        tr.appendChild(pubTd);
        bookTbody.appendChild(tr);
      });
    }

    function enterEditMode() {
      editMode = true;
      orderChanged = false;
      stackTable.classList.add("edit-mode");
      btnEdit.style.display = "none";
      btnSave.style.display = "";
      btnCancel.style.display = "";
      btnSave.disabled = true;
      btnCancel.disabled = false;
      errorMsg.style.display = "none";

      Array.from(bookTbody.rows).forEach(tr => {
        tr.draggable = true;
        tr.addEventListener("dragstart", onDragStart);
        tr.addEventListener("dragover", onDragOver);
        tr.addEventListener("dragleave", onDragLeave);
        tr.addEventListener("drop", onDrop);
        tr.addEventListener("dragend", onDragEnd);
      });
    }

    function exitEditMode() {
      editMode = false;
      orderChanged = false;
      stackTable.classList.remove("edit-mode");
      btnEdit.style.display = "";
      btnSave.style.display = "none";
      btnCancel.style.display = "none";
      errorMsg.style.display = "none";

      Array.from(bookTbody.rows).forEach(tr => {
        tr.draggable = false;
      });
    }

    function onDragStart(e) {
      dragRow = e.currentTarget;
      dragRow.classList.add("dragging");
      e.dataTransfer.effectAllowed = "move";
    }

    function onDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = "move";
      const tr = e.currentTarget;
      if (tr !== dragRow) tr.classList.add("drag-over");
    }

    function onDragLeave(e) {
      e.currentTarget.classList.remove("drag-over");
    }

    function onDrop(e) {
      e.preventDefault();
      const target = e.currentTarget;
      target.classList.remove("drag-over");
      if (!dragRow || target === dragRow) return;

      // Insert dragRow before or after target depending on position
      const rows = Array.from(bookTbody.rows);
      const dragIdx = rows.indexOf(dragRow);
      const targetIdx = rows.indexOf(target);
      if (dragIdx < targetIdx) {
        bookTbody.insertBefore(dragRow, target.nextSibling);
      } else {
        bookTbody.insertBefore(dragRow, target);
      }

      // Renumber positions
      Array.from(bookTbody.rows).forEach((tr, i) => {
        tr.cells[0].textContent = i;
      });

      orderChanged = true;
      btnSave.disabled = false;
      btnCancel.disabled = false;
    }

    function onDragEnd() {
      if (dragRow) dragRow.classList.remove("dragging");
      Array.from(bookTbody.rows).forEach(tr => tr.classList.remove("drag-over"));
      dragRow = null;
    }

    async function saveOrder() {
      const bookIds = Array.from(bookTbody.rows).map(tr => Number(tr.dataset.bookId));
      errorMsg.style.display = "none";
      btnSave.disabled = true;

      try {
        const res = await fetch("/api/stack/" + currentStackId, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ book_ids: bookIds }),
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.detail || "Failed to save");
        }

        const data = await res.json();
        currentBooks = data.books;
        exitEditMode();
        renderBooks(currentBooks);
      } catch (e) {
        errorMsg.textContent = e.message;
        errorMsg.style.display = "block";
        btnSave.disabled = false;
      }
    }

    btnEdit.addEventListener("click", enterEditMode);
    btnCancel.addEventListener("click", () => {
      exitEditMode();
      renderBooks(currentBooks);
    });
    btnSave.addEventListener("click", saveOrder);

    // --- Add Book ---
    const btnAddBook = document.getElementById("btn-add-book");
    const addBookForm = document.getElementById("add-book-form");
    const addBookTitle = document.getElementById("add-book-title");
    const addBookAuthor = document.getElementById("add-book-author");
    const addBookPublisher = document.getElementById("add-book-publisher");
    const addBookPosition = document.getElementById("add-book-position");
    const btnSaveNewBook = document.getElementById("btn-save-new-book");
    const btnCancelNewBook = document.getElementById("btn-cancel-new-book");
    const addBookError = document.getElementById("add-book-error");
    const addBookSuccess = document.getElementById("add-book-success");
    let addBookSuccessTimer = null;

    function resetAddBookForm() {
      addBookTitle.value = "";
      addBookAuthor.value = "";
      addBookPublisher.value = "";
      addBookTitle.disabled = false;
      addBookAuthor.disabled = false;
      addBookPublisher.disabled = false;
      addBookPosition.value = "end";
      btnSaveNewBook.disabled = true;
      addBookError.style.display = "none";
      addBookSuccess.style.display = "none";
      if (addBookSuccessTimer) { clearTimeout(addBookSuccessTimer); addBookSuccessTimer = null; }
    }

    function checkAddBookEnabled() {
      const hasTitle = addBookTitle.value.trim() !== "";
      const hasAuthor = addBookAuthor.value.trim() !== "";
      btnSaveNewBook.disabled = !(hasTitle || hasAuthor);
    }

    btnAddBook.addEventListener("click", () => {
      resetAddBookForm();
      addBookForm.style.display = "block";
      btnAddBook.style.display = "none";
      addBookTitle.focus();
    });

    btnCancelNewBook.addEventListener("click", () => {
      addBookForm.style.display = "none";
      btnAddBook.style.display = "";
      resetAddBookForm();
    });

    addBookTitle.addEventListener("input", checkAddBookEnabled);
    addBookAuthor.addEventListener("input", checkAddBookEnabled);

    btnSaveNewBook.addEventListener("click", async () => {
      addBookError.style.display = "none";
      addBookSuccess.style.display = "none";
      btnSaveNewBook.disabled = true;

      try {
        const res = await fetch("/api/book", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            title: addBookTitle.value.trim(),
            author: addBookAuthor.value.trim() || null,
            publisher: addBookPublisher.value.trim() || null,
            stack_id: Number(currentStackId),
            position: addBookPosition.value,
          }),
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.detail || "Failed to create book");
        }

        await res.json();

        // Refresh the stack to show updated order
        const stackRes = await fetch("/api/stack/" + currentStackId);
        const stackData = await stackRes.json();
        currentBooks = stackData.books;
        renderBooks(currentBooks);

        // Reset and hide form, show success
        addBookForm.style.display = "none";
        btnAddBook.style.display = "";
        resetAddBookForm();

        addBookSuccess.textContent = "Book added successfully.";
        addBookSuccess.style.display = "block";
        addBookForm.style.display = "none";
        addBookSuccessTimer = setTimeout(() => {
          addBookSuccess.style.display = "none";
        }, 3000);
      } catch (e) {
        addBookError.textContent = e.message;
        addBookError.style.display = "block";
        checkAddBookEnabled();
      }
    });

    // --- Edit Stack ---
    const btnEditStack = document.getElementById("btn-edit-stack");
    const stackEditForm = document.getElementById("stack-edit-form");
    const stackEditError = document.getElementById("stack-edit-error");
    const stackEditSuccess = document.getElementById("stack-edit-success");
    const stackEditName = document.getElementById("stack-edit-name");
    const stackEditLocation = document.getElementById("stack-edit-location");
    const btnSaveStackEdit = document.getElementById("btn-save-stack-edit");
    const btnCancelStackEdit = document.getElementById("btn-cancel-stack-edit");
    const stackLocation = document.getElementById("stack-location");
    let currentStackData = null;
    let stackEditSuccessTimer = null;

    function checkStackEditChanged() {
      if (!currentStackData) return;
      const nameChanged = stackEditName.value !== currentStackData.name;
      const locChanged = (stackEditLocation.value || "") !== (currentStackData.location || "");
      btnSaveStackEdit.disabled = !(nameChanged || locChanged);
    }

    btnEditStack.addEventListener("click", () => {
      stackEditForm.style.display = "block";
      btnEditStack.style.display = "none";
      stackEditError.style.display = "none";
      stackEditSuccess.style.display = "none";
      if (stackEditSuccessTimer) { clearTimeout(stackEditSuccessTimer); stackEditSuccessTimer = null; }
      stackEditName.value = currentStackData.name;
      stackEditLocation.value = currentStackData.location || "";
      btnSaveStackEdit.disabled = true;
      stackEditName.focus();
    });

    btnCancelStackEdit.addEventListener("click", () => {
      stackEditForm.style.display = "none";
      btnEditStack.style.display = "";
    });

    stackEditName.addEventListener("input", checkStackEditChanged);
    stackEditLocation.addEventListener("input", checkStackEditChanged);

    btnSaveStackEdit.addEventListener("click", async () => {
      stackEditError.style.display = "none";
      btnSaveStackEdit.disabled = true;

      try {
        const res = await fetch("/api/stack/" + currentStackId, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            name: stackEditName.value.trim(),
            location: stackEditLocation.value.trim() || null,
          }),
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.detail || "Failed to update stack");
        }

        const updated = await res.json();
        currentStackData.name = updated.name;
        currentStackData.location = updated.location;

        // Update display
        stackName.textContent = "Stack " + updated.name;
        stackLocation.textContent = updated.location || "";

        // Update sidebar
        stacksCache = null;
        await loadStacks();
        highlightSidebar(currentStackId);

        stackEditForm.style.display = "none";
        btnEditStack.style.display = "";

        stackEditSuccess.textContent = "Stack updated successfully.";
        stackEditSuccess.style.display = "block";
        stackEditSuccessTimer = setTimeout(() => {
          stackEditSuccess.style.display = "none";
        }, 3000);
      } catch (e) {
        stackEditError.textContent = e.message;
        stackEditError.style.display = "block";
        checkStackEditChanged();
      }
    });

    async function showStack(stackId) {
      await loadStacks();
      highlightSidebar(stackId);
      exitEditMode();
      addBookForm.style.display = "none";
      btnAddBook.style.display = "";
      resetAddBookForm();
      stackEditForm.style.display = "none";
      btnEditStack.style.display = "";
      stackEditSuccess.style.display = "none";

      const res = await fetch("/api/stack/" + stackId);
      if (!res.ok) { showView("welcome"); return; }
      const data = await res.json();

      currentStackId = stackId;
      currentStackData = data;
      currentBooks = data.books;

      stackName.textContent = "Stack " + data.name;
      stackLocation.textContent = data.location || "";
      renderBooks(currentBooks);
      showView("stack");
    }

    function renderBookDetail(book) {
      const stack = stacksCache.find(s => s.id === book.stack_id);
      const stackLabel = stack ? stack.name : String(book.stack_id);

      bookTitle.textContent = book.title;
      bookDetailDl.innerHTML = "";

      const editableFields = [
        ["Title", "title", book.title],
        ["Author", "author", book.author || ""],
        ["Publisher", "publisher", book.publisher || ""],
      ];

      editableFields.forEach(([label, key, value]) => {
        const dt = document.createElement("dt");
        dt.textContent = label;
        const dd = document.createElement("dd");
        dd.dataset.field = key;
        dd.textContent = value || "\u2014";
        bookDetailDl.appendChild(dt);
        bookDetailDl.appendChild(dd);
      });

      const stackDt = document.createElement("dt");
      stackDt.textContent = "Stack";
      const stackDd = document.createElement("dd");
      stackDd.dataset.field = "stack";
      const stackLink = document.createElement("a");
      stackLink.href = "/stacks/" + book.stack_id;
      stackLink.textContent = stackLabel;
      stackLink.addEventListener("click", (e) => {
        e.preventDefault();
        navigate("/stacks/" + book.stack_id);
      });
      stackDd.appendChild(stackLink);
      bookDetailDl.appendChild(stackDt);
      bookDetailDl.appendChild(stackDd);

      const posDt = document.createElement("dt");
      posDt.textContent = "Position";
      const posDd = document.createElement("dd");
      posDd.dataset.field = "position";
      posDd.textContent = book.position;
      bookDetailDl.appendChild(posDt);
      bookDetailDl.appendChild(posDd);
    }

    function checkBookChanged() {
      const titleInput = bookDetailDl.querySelector('dd[data-field="title"] input');
      const authorInput = bookDetailDl.querySelector('dd[data-field="author"] input');
      const pubInput = bookDetailDl.querySelector('dd[data-field="publisher"] input');
      const stackSelect = bookDetailDl.querySelector('dd[data-field="stack"] select');

      const titleChanged = titleInput && titleInput.value !== currentBook.title;
      const authorChanged = authorInput && authorInput.value !== (currentBook.author || "");
      const pubChanged = pubInput && pubInput.value !== (currentBook.publisher || "");
      const stackChanged = stackSelect && Number(stackSelect.value) !== currentBook.stack_id;

      const changed = titleChanged || authorChanged || pubChanged || stackChanged;
      btnBookSave.disabled = !changed;
    }

    function enterBookEditMode() {
      bookEditMode = true;
      btnBookEdit.style.display = "none";
      btnBookSave.style.display = "";
      btnBookCancel.style.display = "";
      btnBookSave.disabled = true;
      btnBookCancel.disabled = false;
      bookErrorMsg.style.display = "none";
      bookSuccessMsg.style.display = "none";
      bookInfoMsg.style.display = "none";
      if (successTimer) { clearTimeout(successTimer); successTimer = null; }

      ["title", "author", "publisher"].forEach(key => {
        const dd = bookDetailDl.querySelector('dd[data-field="' + key + '"]');
        if (!dd) return;
        const val = key === "title" ? currentBook.title :
                    key === "author" ? (currentBook.author || "") :
                    (currentBook.publisher || "");
        const input = document.createElement("input");
        input.type = "text";
        input.name = key;
        input.value = val;
        input.addEventListener("input", checkBookChanged);
        dd.textContent = "";
        dd.appendChild(input);
      });

      // Stack dropdown
      const stackDd = bookDetailDl.querySelector('dd[data-field="stack"]');
      if (stackDd) {
        stackDd.innerHTML = "";
        const select = document.createElement("select");
        select.name = "stack_id";
        stacksCache.forEach(s => {
          const opt = document.createElement("option");
          opt.value = s.id;
          opt.textContent = s.name;
          if (s.id === currentBook.stack_id) opt.selected = true;
          select.appendChild(opt);
        });
        select.addEventListener("change", () => {
          const newId = Number(select.value);
          if (newId !== currentBook.stack_id) {
            const newStack = stacksCache.find(s => s.id === newId);
            const name = newStack ? newStack.name : newId;
            bookInfoMsg.textContent = "Book will be placed at the top (position 0) of Stack " + name + ".";
            bookInfoMsg.style.display = "block";
          } else {
            bookInfoMsg.style.display = "none";
          }
          checkBookChanged();
        });
        stackDd.appendChild(select);
      }
    }

    function exitBookEditMode() {
      bookEditMode = false;
      btnBookEdit.style.display = "";
      btnBookSave.style.display = "none";
      btnBookCancel.style.display = "none";
      bookErrorMsg.style.display = "none";
      bookInfoMsg.style.display = "none";
    }

    async function saveBook() {
      bookErrorMsg.style.display = "none";
      btnBookSave.disabled = true;

      const title = bookDetailDl.querySelector('dd[data-field="title"] input').value;
      const author = bookDetailDl.querySelector('dd[data-field="author"] input').value;
      const publisher = bookDetailDl.querySelector('dd[data-field="publisher"] input').value;
      const stackSelect = bookDetailDl.querySelector('dd[data-field="stack"] select');
      const stackId = stackSelect ? Number(stackSelect.value) : currentBook.stack_id;

      try {
        const res = await fetch("/api/book/" + currentBook.id, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            title: title,
            author: author || null,
            publisher: publisher || null,
            stack_id: stackId,
          }),
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.detail || "Failed to save");
        }

        currentBook = await res.json();
        exitBookEditMode();
        renderBookDetail(currentBook);

        bookSuccessMsg.textContent = "Book updated successfully.";
        bookSuccessMsg.style.display = "block";
        successTimer = setTimeout(() => {
          bookSuccessMsg.style.display = "none";
        }, 3000);
      } catch (e) {
        bookErrorMsg.textContent = e.message;
        bookErrorMsg.style.display = "block";
      } finally {
        btnBookSave.disabled = false;
      }
    }

    btnBookEdit.addEventListener("click", enterBookEditMode);
    btnBookCancel.addEventListener("click", () => {
      exitBookEditMode();
      renderBookDetail(currentBook);
    });
    btnBookSave.addEventListener("click", saveBook);

    async function showBook(bookId) {
      await loadStacks();
      highlightSidebar(null);
      exitBookEditMode();
      bookSuccessMsg.style.display = "none";

      const res = await fetch("/api/book/" + bookId);
      if (!res.ok) { showView("welcome"); return; }
      currentBook = await res.json();

      renderBookDetail(currentBook);
      showView("book");
    }

    function resetNewStackForm() {
      newStackName.value = "";
      newStackName.disabled = false;
      btnCreateStack.disabled = true;
      newStackError.style.display = "none";
      newStackFollowup.style.display = "none";
      createdStackId = null;
    }

    function showNewStack() {
      resetNewStackForm();
      highlightSidebar(null);
      showView("new-stack");
    }

    newStackName.addEventListener("input", () => {
      btnCreateStack.disabled = !newStackName.value.trim();
    });

    btnCreateStack.addEventListener("click", async () => {
      newStackError.style.display = "none";
      btnCreateStack.disabled = true;

      try {
        const res = await fetch("/api/stack", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name: newStackName.value.trim() }),
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.detail || "Failed to create stack");
        }

        const newStack = await res.json();
        createdStackId = newStack.id;

        // Update sidebar
        stacksCache = null;
        await loadStacks();

        newStackName.disabled = true;
        btnCreateStack.disabled = true;
        newStackFollowup.style.display = "flex";
      } catch (e) {
        newStackError.textContent = e.message;
        newStackError.style.display = "block";
        btnCreateStack.disabled = !newStackName.value.trim();
      }
    });

    btnAddAnother.addEventListener("click", () => {
      resetNewStackForm();
    });

    btnGotoStack.addEventListener("click", () => {
      if (createdStackId) navigate("/stacks/" + createdStackId);
    });

    document.getElementById("btn-cancel-create").addEventListener("click", () => {
      navigate("/");
    });

    document.getElementById("sidebar-add-stack").addEventListener("click", () => {
      navigate("/stacks/new");
    });

    // --- Search ---
    const searchInput = document.getElementById("search-input");
    const btnSearch = document.getElementById("btn-search");
    const searchTitle = document.getElementById("search-title");
    const searchAuthor = document.getElementById("search-author");
    const searchPublisher = document.getElementById("search-publisher");
    const searchError = document.getElementById("search-error");
    const searchCount = document.getElementById("search-count");
    const searchResultsTable = document.getElementById("search-results-table");
    const searchResultsTbody = document.getElementById("search-results-tbody");

    async function doSearch() {
      const q = searchInput.value.trim();
      if (!q) return;

      searchError.style.display = "none";
      searchCount.style.display = "none";
      searchResultsTable.style.display = "none";

      const params = new URLSearchParams();
      params.set("q", q);
      params.set("title", searchTitle.checked);
      params.set("author", searchAuthor.checked);
      params.set("publisher", searchPublisher.checked);

      try {
        const res = await fetch("/api/books/search?" + params.toString());
        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.detail || "Search failed");
        }

        const results = await res.json();
        searchResultsTbody.innerHTML = "";

        results.forEach(book => {
          const tr = document.createElement("tr");

          const titleTd = document.createElement("td");
          const titleLink = document.createElement("a");
          titleLink.href = "/book/" + book.id;
          titleLink.textContent = book.title;
          titleLink.addEventListener("click", (e) => {
            e.preventDefault();
            navigate("/book/" + book.id);
          });
          titleTd.appendChild(titleLink);

          const authorTd = document.createElement("td");
          authorTd.textContent = book.author || "\u2014";
          const pubTd = document.createElement("td");
          pubTd.textContent = book.publisher || "\u2014";
          const stackTd = document.createElement("td");
          const stackLink = document.createElement("a");
          stackLink.href = "/stacks/" + book.stack_id;
          stackLink.textContent = book.stack_name;
          stackLink.addEventListener("click", (e) => {
            e.preventDefault();
            navigate("/stacks/" + book.stack_id);
          });
          stackTd.appendChild(stackLink);

          tr.appendChild(titleTd);
          tr.appendChild(authorTd);
          tr.appendChild(pubTd);
          tr.appendChild(stackTd);
          searchResultsTbody.appendChild(tr);
        });

        searchCount.textContent = results.length + " result" + (results.length !== 1 ? "s" : "") + " found.";
        searchCount.style.display = "block";
        if (results.length > 0) searchResultsTable.style.display = "";
      } catch (e) {
        searchError.textContent = e.message;
        searchError.style.display = "block";
      }
    }

    btnSearch.addEventListener("click", doSearch);
    searchInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") doSearch();
    });

    function showSearch() {
      highlightSidebar(null);
      showView("search");
      searchInput.focus();
    }

    document.getElementById("navbar-search").addEventListener("click", (e) => {
      e.preventDefault();
      navigate("/search");
    });

    async function route() {
      const path = window.location.pathname;
      let match;

      if ((match = path.match(/^\/book\/(\d+)$/))) {
        await showBook(match[1]);
      } else if (path === "/search") {
        await loadStacks();
        showSearch();
      } else if (path === "/stacks/new") {
        await loadStacks();
        showNewStack();
      } else if ((match = path.match(/^\/stacks\/(\d+)$/))) {
        await showStack(match[1]);
      } else {
        await loadStacks();
        highlightSidebar(null);
        showView("welcome");
      }
    }

    document.getElementById("navbar-home").addEventListener("click", (e) => {
      e.preventDefault();
      navigate("/");
    });

    window.addEventListener("popstate", route);
    route();
  </script>
</body>
</html>
